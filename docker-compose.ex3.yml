version: "3.8"

services:
  # PostgreSQL Database (shared by all services)
  db:
    image: postgres:16-alpine
    container_name: football-db
    environment:
      POSTGRES_USER: football_user
      POSTGRES_PASSWORD: football_password
      POSTGRES_DB: football_players
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U football_user -d football_players"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - football-network

  # Redis (for background workers and task queue)
  redis:
    image: redis:7-alpine
    container_name: football-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - football-network

  # Main FastAPI Backend Service (EX1+EX2+EX3)
  # - Port 8000: API + Swagger UI at http://localhost:8000/docs
  # - PostgreSQL database (persistent)
  # - JWT authentication
  backend:
    build:
      context: ./backend
      dockerfile: football_player_service/Dockerfile
    container_name: football-backend
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql+psycopg2://football_user:football_password@db:5432/football_players
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET_KEY=your-secret-key-change-in-production-2026
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - football-network

  # Analytics Service (EX3 - AI Insights)
  # - Port 8001: AI analytics API
  # - Mock AI engine (free, fast, deterministic)
  analytics:
    build:
      context: ./backend/analytics_service
      dockerfile: Dockerfile
    container_name: football-analytics
    ports:
      - "8001:8000"
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - football-network

  # Background Worker (EX3 - Async Tasks)
  # - Processes tasks from Redis queue
  # - Market value refresh, analytics batch generation
  worker:
    build:
      context: ./backend/worker_service
      dockerfile: Dockerfile
    container_name: football-worker
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
      - MAIN_API_URL=http://backend:8000
      - ANALYTICS_URL=http://analytics:8000
    networks:
      - football-network

  # React Frontend Service
  # - Port 3000: App at http://localhost:3000
  # - Connects to backend (8000) and analytics (8001)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: football-frontend
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
      analytics:
        condition: service_healthy
    environment:
      # Docker Compose internal network: use service names
      - VITE_API_LOCATION=http://backend:8000
      - VITE_ANALYTICS_LOCATION=http://analytics:8000
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - football-network

volumes:
  # PostgreSQL database persistence
  postgres-data:
    driver: local

networks:
  football-network:
    driver: bridge
